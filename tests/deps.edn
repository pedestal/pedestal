; Copyright 2023-2024 Nubank NA
; Copyright 2022 Cognitect, Inc.

; The use and distribution terms for this software are covered by the
; Eclipse Public License 1.0 (http://opensource.org/licenses/eclipse-1.0)
; which can be found in the file epl-v10.html at the root of this distribution.
;
; By using this software in any fashion, you are agreeing to be bound by
; the terms of this license.
;
; You must not remove this notice, or any other, from this software.

{:paths ["test"
         "dev"
         "bench"
         "resources"]
 ;; Because no artifact is generated from this module, test-only dependencies are top-level.
 :deps {criterium/criterium {:mvn/version "0.4.6"}

        nubank/matcher-combinators {:mvn/version "3.9.1"}
        nubank/mockfn {:mvn/version "0.7.0"}
        expound/expound {:mvn/version "0.9.0"}
        medley/medley {:mvn/version "1.4.0"}

        org.clojure/java.classpath {:mvn/version "1.1.0"}
        org.clojure/tools.namespace {:mvn/version "1.5.0"}
        org.clojure/data.json {:mvn/version "2.5.0"}
        clj-http/clj-http {:mvn/version "3.13.0"}

        hato/hato {:mvn/version "1.0.0"}

        jakarta.servlet/jakarta.servlet-api {:mvn/version "5.0.0"}

        ;; Include *all* the other modules
        io.pedestal/pedestal.log {:local/root "../log"}
        io.pedestal/pedestal.service {:local/root "../service"}
        ;; Recapitulate transitive dependencies of pedestal.service since the
        ;; :local alias isn't carried through when resolving the local dependencies.
        io.pedestal/pedestal.interceptor {:local/root "../interceptor"}
        io.pedestal/pedestal.route {:local/root "../route"}
        io.pedestal/pedestal.telemetry {:local/root "../telemetry"}
        io.pedestal/pedestal.common {:local/root "../common"}
        io.pedestal/pedestal.error {:local/root "../error"}

        io.github.hlship/trace {:mvn/version "1.4"}
        com.walmartlabs/test-reporting {:mvn/version "1.2"}
        com.clojure-goes-fast/clj-async-profiler {:mvn/version "1.3.3"}

        ;; For proper reloading of code in REPL
        io.github.tonsky/clj-reload {:mvn/version "0.7.1"}

        io.github.cognitect-labs/test-runner
        {:git/tag "v0.5.1" :git/sha "dfb30dd"}}


 :aliases
 {:coverage
  {:paths      ["test" "resources"]
   :extra-deps {cloverage/cloverage {:mvn/version "1.2.4"}
                org.eclipse.jetty.toolchain/jetty-jakarta-websocket-api {:mvn/version "2.0.0"}}
   :jvm-opts   ["-Dcollecting-coverage=true"]
   :main-opts  ["--main" "cloverage.coverage"
                "--test-ns-path" "test"
                "--ns-regex" "\\Qio.pedestal.\\E.*"
                "--test-ns-regex" ".*-test"
                "--ns-exclude-regex" ".*test"]}


  :1.12
  {:override-deps {org.clojure/clojure {:mvn/version "1.12.0"}}}

  :1.10
  {:override-deps {org.clojure/clojure {:mvn/version "1.10.3"}}}

  :jetty11
  {:extra-paths ["test-jetty11"]
   :extra-deps {org.eclipse.jetty/jetty-servlets {:mvn/version "11.0.24"}
                io.pedestal/pedestal.jetty11 {:local/root "../jetty11"}}}

  :jetty
  {:extra-paths ["test-jetty"]
   :extra-deps {org.eclipse.jetty.ee10/jetty-ee10-servlets {:mvn/version "12.0.16"}
                io.pedestal/pedestal.jetty {:local/root "../jetty"}
                jakarta.servlet/jakarta.servlet-api {:mvn/version "6.0.0"}}}

  :test
  {
   :jvm-opts ["-Djdk.attach.allowAttachSelf"]
   ;; Need extra test runner to avoid test hangs
   :exec-fn  io.pedestal.test-runner/test}

  ;; clj -T:tests run
  :tests
  {:ns-default tests
   :paths ["tests"]
   :extra-deps {io.github.clojure/tools.build {:mvn/version "0.10.5"}}}

  :otel
  ;; Enable the implementations of OpenTelemetry and configure sources, to allow experimenting at the REPL.
  {:extra-deps {io.opentelemetry/opentelemetry-sdk                         {:mvn/version "1.42.1"}
                io.opentelemetry/opentelemetry-sdk-metrics                 {:mvn/version "1.42.1"}
                io.opentelemetry/opentelemetry-sdk-extension-autoconfigure {:mvn/version "1.42.1"}
                io.opentelemetry/opentelemetry-exporter-otlp               {:mvn/version "1.42.1"}
                io.opentelemetry/opentelemetry-exporter-logging            {:mvn/version "1.42.1"}}
   :jvm-opts   ["-Dotel.exporter.oltp.endpoint=http://localhost:4317"
                ;; Without this, get a warning and no-op behavior:
                "-Dotel.java.global-autoconfigure.enabled=true"
                "-Dotel.resource.attributes=service.name=pedestal-demo-sdk"
                "-Dotel.metrics.exporter=logging"]}

  :otel-agent
  {:jvm-opts ["-Dotel.exporter.oltp.endpoint=http://localhost:4317"
              "-Dotel.resource.attributes=service.name=pedestal-demo-agent"
              "-Dotel.metrics.exporter=none"
              ;; Must download this via
              ;; curl https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar \
              ;;   -O --output-dir target
              "-javaagent:target/opentelemetry-javaagent.jar"]}

  ;; clj -X:bench-log
  ;; Runs a benchmark of io.pedestal.log (~ 44ns), then clojure.tools.logging (~ 57 ns),
  ;; then SL4J with pr-str (~ 28 ns) -- this takes several minutes.
  :bench-log
  {:exec-fn io.pedestal.log-bench/run-benchmarks}}}
